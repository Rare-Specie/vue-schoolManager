# 登录状态优化测试指南

## 测试目标

验证登录状态优化后的各项功能是否正常工作，确保用户在各种场景下都能保持稳定的登录状态。

## 测试环境

- **前端**: 优化后的Vue3项目
- **后端**: 正常运行的API服务
- **浏览器**: Chrome/Firefox/Safari（最新版本）

## 测试场景

### 1. 基础登录状态保持

#### 测试步骤：
1. 使用管理员账号登录
2. 进入"成绩录入"页面
3. 等待5分钟
4. 刷新页面
5. 检查是否仍保持登录状态

#### 预期结果：
- ✅ 页面刷新后仍保持登录
- ✅ 用户信息正确显示
- ✅ 可以正常操作

### 2. Token自动刷新

#### 测试步骤：
1. 登录系统
2. 打开浏览器控制台
3. 等待10分钟（观察控制台日志）
4. 检查token是否自动刷新

#### 预期结果：
- ✅ 控制台显示"Token已自动刷新"
- ✅ 登录状态保持不变
- ✅ 无错误提示

### 3. 页面可见性变化

#### 测试步骤：
1. 登录系统
2. 切换到其他标签页（5分钟）
3. 切换回原标签页
4. 检查登录状态

#### 预期结果：
- ✅ 页面重新可见时状态正常
- ✅ 可能显示刷新提示
- ✅ 无强制登出

### 4. 浏览器关闭重启

#### 测试步骤：
1. 登录系统
2. 关闭浏览器
3. 重新打开浏览器
4. 访问原网址

#### 预期结果：
- ✅ 自动恢复登录状态
- ✅ 显示"登录状态已恢复"提示
- ✅ 可以继续操作

### 5. 长时间闲置

#### 测试步骤：
1. 登录系统
2. 保持页面打开30分钟不操作
3. 尝试进行操作

#### 预期结果：
- ✅ 保持登录状态
- ✅ 可能收到状态即将过期提示
- ✅ 点击刷新后可继续使用

### 6. 网络断开重连

#### 测试步骤：
1. 登录系统
2. 断开网络（关闭WiFi/拔网线）
3. 等待2分钟
4. 重新连接网络
5. 尝试操作

#### 预期结果：
- ✅ 网络恢复后状态保持
- ✅ 可能需要手动刷新
- ✅ 不会强制登出

### 7. 多标签页操作

#### 测试步骤：
1. 登录系统
2. 打开新标签页访问同一系统
3. 在两个标签页间切换操作

#### 预期结果：
- ✅ 两个标签页都保持登录
- ✅ 状态同步正常
- ✅ 无冲突

### 8. 登录状态警告

#### 测试步骤：
1. 登录系统
2. 等待Token即将过期（约20分钟）
3. 观察顶部状态栏

#### 预期结果：
- ✅ 显示黄色警告条
- ✅ 显示剩余时间
- ✅ 点击"刷新"按钮可延长登录

### 9. 手动刷新登录状态

#### 测试步骤：
1. 登录系统
2. 等待出现状态警告
3. 点击"刷新"按钮
4. 检查状态更新

#### 预期结果：
- ✅ 显示"登录状态已刷新"成功提示
- ✅ 警告条消失
- ✅ 登录时间延长

### 10. 登录过期处理

#### 测试步骤：
1. 登录系统
2. 手动清除localStorage中的token
3. 尝试进行操作

#### 预期结果：
- ✅ 显示"登录已过期"提示
- ✅ 自动跳转到登录页
- ✅ 可以重新登录

## API测试

### 1. Token刷新接口
```bash
# 测试token刷新
curl -X POST http://localhost:21180/api/auth/refresh \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json"
```

### 2. 用户信息验证
```bash
# 测试用户信息
curl -X GET http://localhost:21180/api/auth/profile \
  -H "Authorization: Bearer <token>"
```

## 性能测试

### 1. 内存使用
- 监控定时器数量（应不超过3个）
- 检查事件监听器数量
- 验证无内存泄漏

### 2. 网络请求
- 监控自动刷新频率
- 验证无重复请求
- 检查请求成功率

## 错误场景测试

### 1. 后端服务中断
- 启动系统后关闭后端
- 尝试刷新token
- 验证优雅降级

### 2. 网络异常
- 模拟网络延迟
- 模拟网络断开
- 验证恢复机制

### 3. 浏览器异常
- 强制关闭浏览器进程
- 验证会话恢复
- 检查数据完整性

## 测试报告模板

```
登录状态优化测试报告
==================

测试日期: ________
测试人员: ________
浏览器版本: ________

基础功能测试:
□ 登录状态保持 - 通过/失败
□ Token自动刷新 - 通过/失败
□ 页面可见性处理 - 通过/失败
□ 浏览器重启恢复 - 通过/失败
□ 长时间闲置 - 通过/失败
□ 网络断开重连 - 通过/失败
□ 多标签页 - 通过/失败
□ 状态警告 - 通过/失败
□ 手动刷新 - 通过/失败
□ 登录过期处理 - 通过/失败

性能测试:
□ 内存使用正常 - 通过/失败
□ 网络请求优化 - 通过/失败
□ 无内存泄漏 - 通过/失败

错误场景:
□ 后端中断 - 通过/失败
□ 网络异常 - 通过/失败
□ 浏览器异常 - 通过/失败

总体评价: ________
建议改进: ________
```

## 监控指标

### 关键指标
1. **登录状态丢失率**: < 1%
2. **Token刷新成功率**: > 95%
3. **会话恢复成功率**: > 90%
4. **用户重新登录次数**: 显著减少

### 日志监控
```javascript
// 在浏览器控制台查看
console.log('Token已自动刷新')
console.log('会话恢复成功')
console.log('登录状态监控已启动')
```

## 问题排查

### 1. 状态丢失频繁
- 检查tokenManager的定时器是否正常
- 验证localStorage是否被禁用
- 检查是否有其他代码清除token

### 2. 自动刷新失败
- 检查后端API是否正常
- 验证网络连接
- 查看控制台错误信息

### 3. 恢复功能无效
- 检查sessionStorage是否可用
- 验证浏览器隐私模式
- 检查是否有安全策略限制

## 优化建议

如果测试中发现问题，可以：

1. **调整刷新间隔**: 修改TokenManager的检查频率
2. **延长Token有效期**: 调整setToken的过期时间
3. **优化恢复策略**: 改进SessionRecovery的逻辑
4. **增强错误处理**: 添加更多边界情况处理

## 验收标准

✅ **优秀**: 所有测试通过，用户体验流畅
✅ **良好**: 90%测试通过，偶有问题但可恢复
⚠️ **需要改进**: 低于90%通过率，需进一步优化

---

**注意**: 本测试指南应在开发环境和生产环境分别执行，确保优化效果在实际使用中同样有效。