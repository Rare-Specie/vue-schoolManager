# 选课管理界面问题修复总结

## 问题描述
在学生管理-选课管理中，加载课程后无法正常选课，且可能复现 "course not found" 错误。

## 问题分析

### 1. 根本原因
选课管理界面的批量选课功能依赖于 `courseStore.enrollStudentToCourse()` 方法，该方法内部有刷新逻辑：

```typescript
const enrollStudentToCourse = async (courseId: string, studentId: string) => {
  await enrollStudent(courseId, studentId)
  ElMessage.success('选课成功')
  // 刷新选课学生列表 - courseId 是课程编号，需要匹配 currentCourse.courseId
  if (currentCourse.value && currentCourse.value.courseId === courseId) {
    await fetchCourseStudents(courseId)
  }
  return true
}
```

**问题：** 选课管理界面没有设置 `currentCourse.value`，导致刷新逻辑永远不会执行。

### 2. 数据流程问题
```
选课管理界面 → 调用 enrollStudentToCourse → 刷新条件不满足 → 列表不更新
```

## 修复方案

### 1. 选课管理界面手动刷新
**文件：** `src/views/students/EnrollmentManagement.vue`

**修改位置：** `batchEnroll` 方法

**修复前：**
```typescript
for (const sid of ids) {
  try {
    await courseStore.enrollStudentToCourse(courseCode, sid)
    success++
  } catch (e) {
    failed++
  }
}

await refreshEnrolled()  // 手动刷新
```

**修复后：**
```typescript
for (const sid of ids) {
  try {
    await courseStore.enrollStudentToCourse(courseCode, sid)
    success++
  } catch (e) {
    failed++
  }
}

// 手动刷新选课学生列表（因为选课管理界面没有设置 currentCourse）
await refreshEnrolled()
```

### 2. 确保课程编号转换正确
选课管理界面已经正确地将数据库ID转换为课程编号：

```typescript
// 查找当前选中的课程，获取课程编号
const selectedCourse = courseStore.courses.find(c => c.id === form.value.courseId)
if (!selectedCourse) {
  ElMessage.error('找不到选中的课程信息')
  return
}

// 使用课程编号而不是数据库ID
const courseCode = selectedCourse.courseId

await courseStore.enrollStudentToCourse(courseCode, sid)
```

## 修复验证

### 测试步骤
1. 进入学生管理 → 选课管理
2. 选择课程（确保课程列表已加载）
3. 选择多个学生
4. 点击"批量添加选课"
5. 观察结果

### 预期结果
- ✅ 选课成功，显示成功消息
- ✅ 已选学生列表立即更新
- ✅ 无 "course not found" 错误

## 相关文件修改
- ✅ `src/views/students/EnrollmentManagement.vue` - 确保批量选课后手动刷新列表

## 注意事项
1. 选课管理界面没有设置 `currentCourse`，所以依赖 store 自动刷新的逻辑不会生效
2. 必须在选课操作后手动调用 `refreshEnrolled()` 来更新界面
3. 移除选课功能已经正确调用了 `refreshEnrolled()`，无需修改