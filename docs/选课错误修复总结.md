# 选课 "course not found" 错误修复总结

## 问题描述
用户在选课时遇到 "course not found" 错误，无法进行选课操作。

## 问题根源分析

### 1. 数据ID混淆问题
在选课功能中存在两种课程ID：
- **数据库ID (id)**: 课程在数据库中的唯一标识，如 "677f8a2b1a2b3c4d5e6f7g8h"
- **课程编号 (courseId)**: 课程的业务编号，如 "C101"、"MATH101"

### 2. 问题位置

#### 学生详情界面 (StudentDetail.vue)
**问题代码：**
```typescript
const enrollStudentForCurrentStudent = async () => {
  const cid = enrollmentForm.value.courseId  // 这是数据库ID
  // ...
  await courseStore.enrollStudentToCourse(cid, sid)  // 直接传递数据库ID
}
```

**问题分析：**
- `enrollmentForm.value.courseId` 来自课程选择器，值为课程的数据库ID
- 但 `enrollStudentToCourse` 期望接收课程编号
- API 调用路径：`POST /api/courses/{courseId}/enroll` 需要课程编号

#### Course Store (course.ts)
**问题代码：**
```typescript
const enrollStudentToCourse = async (courseId: string, studentId: string) => {
  await enrollStudent(courseId, studentId)
  // 刷新逻辑问题
  if (currentCourse.value && currentCourse.value.id === courseId) {
    await fetchCourseStudents(courseId)
  }
}
```

**问题分析：**
- `courseId` 参数是课程编号
- 但条件判断使用 `currentCourse.value.id === courseId`（数据库ID vs 课程编号）
- 这导致刷新逻辑永远无法执行

## 修复方案

### 1. 修复学生详情界面
**文件：** `src/views/students/StudentDetail.vue`

**修改前：**
```typescript
const enrollStudentForCurrentStudent = async () => {
  const cid = enrollmentForm.value.courseId
  // ...
  await courseStore.enrollStudentToCourse(cid, sid)
}
```

**修改后：**
```typescript
const enrollStudentForCurrentStudent = async () => {
  const cid = enrollmentForm.value.courseId
  // ...
  // 查找选中的课程，获取课程编号
  const selectedCourse = courseStore.courses.find(c => c.id === cid)
  if (!selectedCourse) {
    ElMessage.error('系统错误：找不到对应的课程信息')
    return
  }
  
  // 使用课程编号而不是数据库ID
  const courseCode = selectedCourse.courseId
  
  await courseStore.enrollStudentToCourse(courseCode, sid)
}
```

### 2. 修复 Course Store
**文件：** `src/stores/course.ts`

**修改前：**
```typescript
const enrollStudentToCourse = async (courseId: string, studentId: string) => {
  await enrollStudent(courseId, studentId)
  ElMessage.success('选课成功')
  // 刷新选课学生列表
  if (currentCourse.value && currentCourse.value.id === courseId) {
    await fetchCourseStudents(courseId)
  }
  return true
}

const unenrollStudentFromCourse = async (courseId: string, studentId: string) => {
  await unenrollStudent(courseId, studentId)
  ElMessage.success('取消选课成功')
  // 刷新选课学生列表
  if (currentCourse.value && currentCourse.value.id === courseId) {
    await fetchCourseStudents(courseId)
  }
  return true
}
```

**修改后：**
```typescript
const enrollStudentToCourse = async (courseId: string, studentId: string) => {
  await enrollStudent(courseId, studentId)
  ElMessage.success('选课成功')
  // 刷新选课学生列表 - courseId 是课程编号，需要匹配 currentCourse.courseId
  if (currentCourse.value && currentCourse.value.courseId === courseId) {
    await fetchCourseStudents(courseId)
  }
  return true
}

const unenrollStudentFromCourse = async (courseId: string, studentId: string) => {
  await unenrollStudent(courseId, studentId)
  ElMessage.success('取消选课成功')
  // 刷新选课学生列表 - courseId 是课程编号，需要匹配 currentCourse.courseId
  if (currentCourse.value && currentCourse.value.courseId === courseId) {
    await fetchCourseStudents(courseId)
  }
  return true
}
```

## 已验证正确的实现

以下界面的选课逻辑已经正确，无需修改：

### 1. 成绩录入界面 (GradeInput.vue)
```typescript
// 正确：先查找课程，再获取课程编号
const currentCourse = courseStore.courses.find(c => c.id === selectForm.courseId)
const courseCode = currentCourse.courseId
await courseStore.enrollStudentToCourse(courseCode, enrollmentForm.studentId)
```

### 2. 选课管理界面 (EnrollmentManagement.vue)
```typescript
// 正确：先查找课程，再获取课程编号
const selectedCourse = courseStore.courses.find(c => c.id === form.value.courseId)
const courseCode = selectedCourse.courseId
await courseStore.enrollStudentToCourse(courseCode, sid)
```

### 3. 学生详情界面 - 取消选课
```typescript
// 已修复：row.courseId 是课程编号，直接传递
await courseStore.unenrollStudentFromCourse(row.courseId, sid)
```

## 修复验证

### 测试步骤
1. 登录管理员/教师账号
2. 进入学生详情页面
3. 在选课管理区域选择课程
4. 点击"添加选课"按钮
5. 验证是否成功选课

### 预期结果
- ✅ 选课成功，显示成功消息
- ✅ 已选课程列表更新
- ✅ 无 "course not found" 错误

## 技术要点总结

1. **ID类型区分**：
   - 数据库ID：用于数据关联和内部逻辑
   - 课程编号：用于API调用和业务标识

2. **数据转换**：
   - UI表单使用数据库ID
   - API调用需要课程编号
   - 必须在调用前进行转换

3. **一致性检查**：
   - Store中的条件判断要与参数类型一致
   - 避免混用数据库ID和课程编号

## 相关文件修改
- ✅ `src/views/students/StudentDetail.vue` - 修复选课逻辑
- ✅ `src/stores/course.ts` - 修复刷新逻辑条件