<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€‰è¯¾ç®¡ç†è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .section h3 { margin-top: 0; color: #333; }
        .success { color: #67c23a; background: #f0f9eb; padding: 8px; border-radius: 4px; }
        .error { color: #f56c6c; background: #fef0f0; padding: 8px; border-radius: 4px; }
        .warning { color: #e6a23c; background: #fdf6ec; padding: 8px; border-radius: 4px; }
        .info { color: #909399; background: #f4f4f5; padding: 8px; border-radius: 4px; }
        .code { background: #f6f8fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        button.primary { background: #409eff; color: white; }
        button.success { background: #67c23a; color: white; }
        button.danger { background: #f56c6c; color: white; }
        .test-result { margin: 10px 0; padding: 10px; border-left: 4px solid #409eff; background: #f0f9eb; }
        .test-error { border-left-color: #f56c6c; background: #fef0f0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é€‰è¯¾ç®¡ç†é¡µé¢è°ƒè¯•å·¥å…·</h1>
        <p>ç”¨äºè¯Šæ–­"ç•Œé¢åŠ è½½å¤±è´¥"é—®é¢˜</p>

        <div class="section">
            <h3>1. æ£€æŸ¥ç½‘ç»œè¿æ¥</h3>
            <button class="primary" onclick="testNetwork()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
            <div id="network-result"></div>
        </div>

        <div class="section">
            <h3>2. æ£€æŸ¥APIç«¯ç‚¹</h3>
            <button class="primary" onclick="testAPIEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
            <div id="api-result"></div>
        </div>

        <div class="section">
            <h3>3. æ£€æŸ¥è®¤è¯çŠ¶æ€</h3>
            <button class="primary" onclick="checkAuth()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
            <div id="auth-result"></div>
        </div>

        <div class="section">
            <h3>4. æ¨¡æ‹Ÿé¡µé¢åŠ è½½</h3>
            <button class="success" onclick="simulatePageLoad()">æ¨¡æ‹Ÿé¡µé¢åŠ è½½æµç¨‹</button>
            <div id="load-result"></div>
        </div>

        <div class="section">
            <h3>5. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°</h3>
            <div class="info">
                è¯·æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾é¡µæ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯ã€‚<br>
                ç‰¹åˆ«å…³æ³¨ï¼š<br>
                - çº¢è‰²é”™è¯¯ä¿¡æ¯<br>
                - ç½‘ç»œè¯·æ±‚å¤±è´¥ (404, 500, CORSç­‰)<br>
                - æœªæ•è·çš„å¼‚å¸¸
            </div>
        </div>

        <div class="section">
            <h3>6. å¸¸è§é—®é¢˜æ£€æŸ¥æ¸…å•</h3>
            <div id="checklist">
                <div>â–¡ åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Ÿ</div>
                <div>â–¡ APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼Ÿ</div>
                <div>â–¡ æ˜¯å¦æœ‰è·¨åŸŸé—®é¢˜ï¼Ÿ</div>
                <div>â–¡ ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Ÿ</div>
                <div>â–¡ Tokenæ˜¯å¦æœ‰æ•ˆï¼Ÿ</div>
                <div>â–¡ æµè§ˆå™¨æ˜¯å¦æœ‰ç¼“å­˜é—®é¢˜ï¼Ÿ</div>
            </div>
            <button onclick="clearCache()">æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        function showResult(elementId, content, isError = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            const div = document.createElement('div');
            div.className = isError ? 'test-result test-error' : 'test-result';
            div.innerHTML = content;
            el.innerHTML = '';
            el.appendChild(div);
        }

        async function testNetwork() {
            const resultEl = document.getElementById('network-result');
            try {
                // æµ‹è¯•æ˜¯å¦èƒ½è®¿é—®æœåŠ¡å™¨
                const response = await fetch('/');
                showResult('network-result', `<div class="success">âœ… ç½‘ç»œè¿æ¥æ­£å¸¸ - æœåŠ¡å™¨å“åº”: ${response.status}</div>`);
            } catch (error) {
                showResult('network-result', `<div class="error">âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ${error.message}<br>è¯·æ£€æŸ¥ï¼š<br>1. æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ<br>2. æ˜¯å¦æœ‰è·¨åŸŸé—®é¢˜<br>3. ç½‘ç»œé˜²ç«å¢™è®¾ç½®</div>`, true);
            }
        }

        async function testAPIEndpoints() {
            const resultEl = document.getElementById('api-result');
            const endpoints = [
                { name: 'è¯¾ç¨‹åˆ—è¡¨', url: '/courses' },
                { name: 'å­¦ç”Ÿåˆ—è¡¨', url: '/students' },
                { name: 'è®¤è¯çŠ¶æ€', url: '/auth/status' }
            ];

            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                        }
                    });
                    
                    if (response.ok) {
                        results.push(`<div class="success">âœ… ${endpoint.name}: ${response.status}</div>`);
                    } else if (response.status === 401) {
                        results.push(`<div class="warning">âš ï¸ ${endpoint.name}: ${response.status} (éœ€è¦ç™»å½•)</div>`);
                    } else if (response.status === 404) {
                        results.push(`<div class="error">âŒ ${endpoint.name}: ${response.status} (æ¥å£ä¸å­˜åœ¨)</div>`);
                    } else {
                        results.push(`<div class="warning">âš ï¸ ${endpoint.name}: ${response.status}</div>`);
                    }
                } catch (error) {
                    results.push(`<div class="error">âŒ ${endpoint.name}: ${error.message}</div>`);
                }
            }
            
            showResult('api-result', results.join(''));
        }

        function checkAuth() {
            const token = localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            const resultEl = document.getElementById('auth-result');
            
            let results = [];
            
            if (token) {
                results.push(`<div class="success">âœ… Tokenå­˜åœ¨: ${token.substring(0, 20)}...</div>`);
            } else {
                results.push(`<div class="error">âŒ Tokenä¸å­˜åœ¨ - ç”¨æˆ·å¯èƒ½æœªç™»å½•</div>`);
            }
            
            if (userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    results.push(`<div class="success">âœ… ç”¨æˆ·ä¿¡æ¯å­˜åœ¨: ${user.username || user.name}</div>`);
                } catch (e) {
                    results.push(`<div class="warning">âš ï¸ ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯</div>`);
                }
            } else {
                results.push(`<div class="error">âŒ ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨</div>`);
            }
            
            showResult('auth-result', results.join(''));
        }

        async function simulatePageLoad() {
            const resultEl = document.getElementById('load-result');
            const steps = [];
            
            steps.push('<div>å¼€å§‹æ¨¡æ‹Ÿé€‰è¯¾ç®¡ç†é¡µé¢åŠ è½½æµç¨‹...</div>');
            
            // æ­¥éª¤1: æ£€æŸ¥è®¤è¯
            const token = localStorage.getItem('token');
            if (!token) {
                showResult('load-result', `<div class="error">âŒ åŠ è½½å¤±è´¥: ç”¨æˆ·æœªç™»å½•<br><a href="/login" style="color: #409eff;">è¯·å…ˆç™»å½•</a></div>`, true);
                return;
            }
            steps.push('<div class="success">âœ… 1. è®¤è¯æ£€æŸ¥é€šè¿‡</div>');
            
            // æ­¥éª¤2: åŠ è½½è¯¾ç¨‹
            try {
                const coursesResp = await fetch(`${API_BASE}/courses?page=1&limit=200`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!coursesResp.ok) throw new Error(`è¯¾ç¨‹åŠ è½½å¤±è´¥: ${coursesResp.status}`);
                const coursesData = await coursesResp.json();
                steps.push(`<div class="success">âœ… 2. è¯¾ç¨‹åŠ è½½æˆåŠŸ (${coursesData.data?.length || 0} é—¨è¯¾ç¨‹)</div>`);
            } catch (e) {
                steps.push(`<div class="error">âŒ 2. è¯¾ç¨‹åŠ è½½å¤±è´¥: ${e.message}</div>`);
                showResult('load-result', steps.join(''), true);
                return;
            }
            
            // æ­¥éª¤3: åŠ è½½å­¦ç”Ÿ
            try {
                const studentsResp = await fetch(`${API_BASE}/students?page=1&limit=1000`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!studentsResp.ok) throw new Error(`å­¦ç”ŸåŠ è½½å¤±è´¥: ${studentsResp.status}`);
                const studentsData = await studentsResp.json();
                steps.push(`<div class="success">âœ… 3. å­¦ç”ŸåŠ è½½æˆåŠŸ (${studentsData.data?.length || 0} åå­¦ç”Ÿ)</div>`);
            } catch (e) {
                steps.push(`<div class="error">âŒ 3. å­¦ç”ŸåŠ è½½å¤±è´¥: ${e.message}</div>`);
                showResult('load-result', steps.join(''), true);
                return;
            }
            
            steps.push('<div class="success"><strong>âœ… é¡µé¢åŠ è½½æµç¨‹å®Œæˆ - è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯</strong></div>');
            showResult('load-result', steps.join(''));
        }

        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            alert('ç¼“å­˜å·²æ¸…é™¤ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkAuth();
            }, 500);
        });
    </script>
</body>
</html>